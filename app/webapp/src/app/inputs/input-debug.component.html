<!-- last key -->

<div class="flex child-margin-1" style="min-width: 98vw;">
  <div class="flex-stacked">
    <label for="keyboardTestingArea">‚å®Ô∏è Keyboard testing</label>
    <div class="bg-grey pad-xs flex-1">

      <input type="text" id="keyboardTestingArea" placeholder="place cursor here to lock"
        (keyup)="$event.preventDefault()" (keydown)="$event.preventDefault()"
        class="width-full"
      />
      
      <h2>Currently pressed</h2>
      <ng-container *ngTemplateOutlet="table;context:{pressed:pressed}"></ng-container>
      
      <ng-container *ngIf="lastPresses.pastPressArray.length">
        <h2>Last {{ lastPresses.pastPressArray.length }} pressed</h2>
        <div class="text-xs">
          <ng-container *ngTemplateOutlet="table;context:{pressed:lastPresses.pastPressArray}"></ng-container>
        </div>
      </ng-container>
  
      <!--
        <button (click)="viewButtonMap = !viewButtonMap"
          [class.active]="viewButtonMap" type="button" class="width-full flex1"
        >üó∫ view all mappings</button>
      -->
    </div>
  </div>

  <div class="flex-stacked flex-1">
    <label for="keyboardTestingArea">üó∫ Mapping Results</label>
    <div *ngIf="!platformPressed.length" class="bg-grey opacity-80 height-full flex-valign-center border flex-center width-full">
      <div class="text-center">
        <h3>Press any key...</h3>
        <a routerLink="../keyboard" class="text-xxs text-white">edit mappings</a>
      </div>
    </div>
    <div class="flex-center flex-1 bg-grey">
      <div>
        <div class="flex-wrap flex-evenly child-margin-1">
          <ng-container *ngFor="let platformPress of platformPressed">
            <div class="flex1 border" *ngFor="let playerPress of platformPress.playerPresses">
              <div class="pad-xxs bg-black text-center text-smx"
              >{{platformPress.platform.label}} Player {{ playerPress.playerIndex + 1 }}</div>
              <div class="flex-center">
                <platform-control-map
                  [platform]        = "platformPress.platform"
                  [playerIndex]     = "playerPress.playerIndex"
                  [controllerSize]  = "10"
                  [pressedObject]   = "playerPress.pressedObject"
                ></platform-control-map>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<!--
  <div *ngIf="viewButtonMap">
    <textarea readonly class="width-full min-height-400" wrap="off"
    >{{ controlMap | json }}</textarea>
  </div>
-->


<ng-template #table let-pressed="pressed">
  <table cellPadding="2" cellSpacing="2" border="0" class="width-full bg-dark">
    <thead>
      <tr>
        <th>code</th>
        <th>key</th>
        <th>which</th>
        <th>mappings</th>
      </tr>
    </thead>
    <tbody class="bg-black">
      <tr *ngIf="!pressed.length">
        <td></td>
        <td></td>
        <td></td>
        <td class="text-xs">
          <ul class="invisible">
            <li>&nbsp;</li>
            <li>&nbsp;</li>
          </ul>
        </td>
      </tr>
      <tr *ngFor="let lastPress of $any(pressed)">
        <td>{{ lastPress.code }}</td>
        <td>{{ lastPress.key }}</td>
        <td>{{ lastPress.which }}</td>
        <td class="text-xxs">
          <ul *ngIf="lastPress.mappings" class="pad-v-0 margin-v-0 pad-left-2x">
            <ng-container *ngTemplateOutlet="mappings;context:{ mappings: lastPress.mappings}"></ng-container>
          </ul>    
        </td>
      </tr>
    </tbody>
  </table>
</ng-template>

<ng-template #mappings let-mappings="mappings">
  <div *ngIf="mappings.length === 1">
    {{ mappings[0].platform.label }} P{{ mappings[0].playerIndex + 1 }} {{ mappings[0].control.label }}
  </div>
  <div *ngIf="mappings.length > 1">
    <li *ngFor="let map of mappings">{{ map.platform.label }} P{{ map.playerIndex + 1 }} {{map.control.label}}</li>
  </div>
</ng-template>