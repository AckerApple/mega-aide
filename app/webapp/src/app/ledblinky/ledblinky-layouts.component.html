<!-- show single light details -->
<div *ngIf="(showLightDetails$ | async) as light" class="flex-center"
  [@fadeInOutUp]="1"
>
  <div class="pos-abs width-full height-full flex-center flex-valign-center bg-dark opacity-half"
    (click)="showLightDetails$.next(undefined)"
    style="z-index:2"
  ></div>
  <!-- single light editor modal-->
  <div class="pos-abs pad" style="z-index:3">
    <ng-container *ngTemplateOutlet="singleLightDetails;context:{
      $implicit: light.light,
      lightControl: light,
      details: $any(light.light).details$ | async,
      zoom: session.ledBlinky.zoom$ | async
    }"></ng-container>
  </div>
</div>

<ng-container *ngTemplateOutlet="stage;context: {
  zoom: session.ledBlinky.zoom$ | async,
  lights: lights$ | async
}"></ng-container>

<ng-template #stage let-zoom="zoom" let-lights="lights">
  <ng-container *ngTemplateOutlet="toolsStage;context:{zoom: zoom, lights:lights}"></ng-container>
  <ng-container *ngTemplateOutlet="lightStage;context:{zoom: zoom}"></ng-container>
</ng-template>

<!-- tools -->
<ng-template #toolsStage let-zoomVar="zoom" let-lights="lights">
  <div class="flex-wrap gap bg-grey pad-xs flex-apart">
    <div class="flex1">
      <div>ðŸ”¬ zoom {{zoomVar}}</div>
      <div class="flex">
        <a (click)="zoomVar <= 0 || session.ledBlinky.zoom$.next(zoomVar - .5)">âŠ–</a>
        <input type="range" id="zoom" min="1" max="5"
          [ngModel]="session.ledBlinky.zoom$ | async" step=".5"
          (ngModelChange) = "session.ledBlinky.zoom$.next($event)"
          class="flex1"
        />
        <a (click)="zoomVar >= 5 || session.ledBlinky.zoom$.next(zoomVar + .5)">âŠ•</a>
      </div>
    </div>

    <div class="flex1">
      <div>ðŸ–Œ layout</div>
      <select class="width-full" [ngModel]="layoutName$ | async" (ngModelChange)="layoutName$$.next($event)">
        <option [value]="name" *ngFor="let name of layoutNames">{{name}}</option>
      </select>
    </div>

    <div class="flex1">
      <div title="Light produced by actual LEDs sometimes do not match the exact requested color. This color curve can help reality meet color mappings."
      >ðŸŒˆ color curve {{session.ledBlinky.curve$ | async | number : '1.0-1'}}</div>
      <div class="flex">
        <a (click)="session.ledBlinky.curve$.getValue() <= .1 || session.ledBlinky.curve$.next(session.ledBlinky.curve$.getValue() - .1)">âŠ–</a>
        <input type="range" id="curve" min="0" max="1"
          [ngModel]="session.ledBlinky.curve$ | async" step=".1"
          (ngModelChange) = "session.ledBlinky.curve$.next($event)"
          class="flex1"
        />
        <a (click)="session.ledBlinky.curve$.getValue() > .9 || session.ledBlinky.curve$.next(session.ledBlinky.curve$.getValue() + .1)">âŠ•</a>
      </div>
    </div>

    <div class="flex1">
      <div>&nbsp;</div>
      <button type="button" (click)="previewSelectedLayoutFile()"
        class="width-full"
      >ðŸ”Ž view file</button>
    </div>

    <div *ngIf="edit" class="flex1">
      <div>add button</div>
      <select (change)="addLight(lights, $any($event.target).value)" class="width-full">
        <option>-- CHOOSE A BUTTON --</option>
        <ng-container *ngFor="let missing of (missingLights$ | async)">
          <ng-container *ngTemplateOutlet="missingOption;context:{
            $implicit: missing.details$ | async
          }"></ng-container>
        </ng-container>
      </select>
    </div>
  </div>
</ng-template>

<ng-template #missingOption let-details>
  <option [value]="details.name">{{ details.name}}</option>
</ng-template>

<ng-template #lightStage let-zoomVar="zoom">
  <!-- light stage-->
  <div class="border pos-rel bg-black overflow" style="max-width: 100vw;max-height: 95vh;"
    [style.width.%] = "widthFull && 100"
    [style.width.px]="!widthFull && (bounds.horizontal.max || session.ledBlinky.displaySize?.width || 1024) * zoomVar"
    [style.height.px]="(bounds.vertical.max || session.ledBlinky.displaySize?.height || 768) * zoomVar"
    
    (drop)="onDropLight($event)"
    (dragover)="stopDrag($event)"
    
    [drag-selector]="selectedLights"
  >
    <!-- light loop -->
    <ng-container *ngFor="let light of lights$ | async">
      <ng-container *ngIf="(light.light.details$ | async) as details">
        <div 
          class="pos-abs flex-stacked flex-center cursor-pointer"
          [style.left.px] = "(details.x - bounds.horizontal.min) * zoomVar"
          [style.top.px] = "(details.y - bounds.vertical.min) * zoomVar"
          (dragstart)="setLightDrag($event, light.light)"
          (drag)="updateLightDrag($event, light.light)"
          [draggable]="edit"
          (click)="showLightDetails$.next(light);modalOpen.emit(light)"
      
          #dragSelectorTarget="dragSelectorTarget"
          [drag-selector-target]="light.light"
        >
          <ng-container *ngTemplateOutlet="lightTemplate;context:{
            $implicit: light.light,
            details: details,
            zoom:zoomVar,
            dragSelectorTarget:dragSelectorTarget
          }"></ng-container>
        </div>    
        </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-template #singleLightDetails let-light
  let-lightControl="lightControl"
  let-details="details"
  let-zoom="zoom"
>
  <div>
    <div class="text-black pad pos-rel border-4"
      style="background-color:rgba(255,255,255,.9);border-color:rgba(255,255,255,.8);min-width:35vw"
    >
      <a class="pos-abs pad-xxs text-2x"
        style="right:-5px;top:-5px"
        (click)="showLightDetails$.next(undefined)"
      >ðŸ…§</a>

      <!-- single light sample -->
      <div class="flex gap">
        <div class="bg-grey-3x flex-1"></div>
        <div class="flex-center flex-stacked">
          <ng-container *ngTemplateOutlet="lightTemplate;context:{
            $implicit: light,
            details: light.details$ | async,
            zoom: zoom
          }"></ng-container>
        </div>
        <div class="bg-grey-3x flex-1"></div>
      </div>

      <br />
      
      <ng-container *ngIf="modalTemplate; else defaultModal">
        <ng-container *ngTemplateOutlet="modalTemplate;context:{
          $implicit: lightControl,
          lightDetails:details
        }"></ng-container>
      </ng-container>

      <ng-template #defaultModal>
        <!-- hint: single control editor / single control display-->
        <h3>Single control {{ edit ? 'editor' : 'details'}}</h3>
        <br />

        <ng-container *ngIf="edit">
          <div class="flex-wrap gap child-bg-grey-5x child-pad-xxs">
            <ng-container *ngTemplateOutlet="lightForm;context:{$implicit:light, details:details}"></ng-container>
          </div>
          <button type="button" class="width-full"
            [class.bg-calm]="!lightControl.showGamesUsing"
            [class.bg-dark]="lightControl.showGamesUsing"
            (click)="lightControl.showGamesUsing = !lightControl.showGamesUsing"
          >ðŸ‘¾ SHOW ROMS USING</button>
          <div *ngIf="lightControl.showGamesUsing" [@fadeInOutUp]="1">
            <light-control-same-roms [lightControl]="lightControl"></light-control-same-roms>
          </div>
        </ng-container>

        <div *ngIf="!edit" class="flex-wrap gap">
          <ng-container *ngTemplateOutlet="lightDetails;context:{$implicit:light, details:details}"></ng-container>
        </div>
      </ng-template>
    </div>
  </div>
</ng-template>

<ng-template #lightTemplate let-light
  let-details="details"
  let-zoom="zoom"
  let-dragSelectorTarget="dragSelectorTarget"
>
  <div class="radius-half"
    [style.width.px] = "details.diameter * zoom"
    [style.height.px] = "details.diameter * zoom"
    [style.background-color] = "light.cssColor$ | async"
    [ngClass] = "dragSelectorTarget?.selected ? 'border-2 border-white' : ''"
    style="box-shadow: .04em .04em .04em .04em rgba(255, 255, 255, 0.3);"
  ></div>
  <div [style.font-size.px]="($any(lightConfig?.settings?.LEDLabelFontSize | number) || 12) * zoom"
  >{{details.name}}</div>
</ng-template>

<ng-template #lightForm let-light let-details="details">
  <select [(ngModel)]="details.name">
    <option>-- CHOOSE A BUTTON --</option>
    <option *ngFor="let label of (session.ledBlinky.inputsMap$ | async)?.labels"
      [value]="label.label"
    >{{ label.label }}</option>
  </select>

  <div class="flex1">
    <div>x</div>
    <input type="range" class="width-full"
      [(ngModel)]="details.x"
      min="0" [max]="(session.ledBlinky.displaySize?.width || 1024) - (details.diameter || 0)"
      step="1"
    />
  </div>
  
  <div class="flex1">
    <div>y</div>
    <input type="range" class="width-full"
      [(ngModel)]="details.y"
      min="0" [max]="(session.ledBlinky.displaySize?.height || 768) -  (details.diameter || 0)"
      step="1"
    />
  </div>
  
  <div class="flex1">
    <div>diameter</div>
    <input type="range" class="width-full"
      [(ngModel)]="details.diameter" min="3" [max]="150"
    />
  </div>
  
  <div class="flex1">
    <div>colorDec</div>
    <div class="flex-wrap">
      <input type="color"
        [ngModel]="light.cssColor$ | async"
        (ngModelChange)="updateLightColor(light, details, $event)"
        [style.background-color]="light.cssColor$ | async"
      />
      <div class="flex1">
        <input type="number" class="width-full"
          [(ngModel)]="details.colorDec"
        />
      </div>
    </div>
  </div>
</ng-template>

<ng-template #lightDetails let-light let-details="details">
  <div class="flex1">
    <strong>name</strong>
    <div class="pad-xxs">
      {{ details.name }}
    </div>
  </div>

  <div class="flex1">
    <strong>coords</strong>
    <div class="pad-xxs">
      {{ details.x}}x {{ details.y}}y
    </div>
  </div>
  
  <div class="flex1">
    <strong>diameter</strong>
    <div class="pad-xxs">
      {{ details.diameter}}px
    </div>
  </div>
  
  <div class="flex1">
    <strong>colorDec</strong>
    <div class="pad-xxs text-shadow-white-blur" [style.background-color]="light.cssColor$ | async"
    >{{ details.colorDec }}</div>
  </div>
</ng-template>
